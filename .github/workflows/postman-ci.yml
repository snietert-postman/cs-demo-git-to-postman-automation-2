name: Postman CI/CD Pipeline

on:
  push:
    branches:
      - '**'  # Trigger on all branches
      - '!main'  # Exclude main branch to prevent duplicate runs
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  # Job 1: Spec Lint - Runs on all branches
  spec-lint:
    name: Spec Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Lint API Specifications
        run: |
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
          
          # Lint all collections
          echo "Linting Open API Spec containeing all APIs..."
          postman spec lint openapi.json
          
  # Job 2: Functional Tests - Runs on all branches, depends on spec-lint
  functional-tests:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: [spec-lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Application Dependencies
        run: |
          echo "Installing application dependencies..."
          yarn install
      
      - name: Build Application
        run: |
          echo "Building NestJS application..."
          yarn build
      
      - name: Start NestJS Application
        run: |
          echo "Starting NestJS application..."
          yarn start &
          
          # Wait for the application to be ready
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/ > /dev/null; then
              echo "‚úÖ Application is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # Verify the application is running
          curl http://localhost:3000/ || (echo "‚ùå Application failed to start" && exit 1)
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Run Collection Tests
        run: |
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
          
          # Run Inventory Management API tests
          echo "Running Inventory Management API tests..."
          postman collection run postman/collections/Inventory-Management-API-Updated.postman_collection.json \
            -e postman/environments/Localhost.postman_environment.json \
            -r cli,json
          
          # Run Customer Feedback API tests
          echo "Running Customer Feedback API tests..."
          postman collection run postman/collections/Customer-Feedback-API.postman_collection.json \
            -e postman/environments/Localhost.postman_environment.json \
            -r cli,json
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-feature
          path: |
            inventory-results.json
            feedback-results.json

  # Job 3: Push to Postman - Runs only on main branch after successful tests
  push-to-postman:
    name: Push to Postman Workspace
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    needs: [functional-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Push Collections to Postman Workspace
        run: |
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
          
          echo "Pushing collections to Postman workspace..."
          
          # Push Inventory Management API
          echo "Pushing Inventory Management API..."
          postman collection push postman/collections/Inventory-Management-API-Updated.postman_collection.json \
            --workspace-id ${{ secrets.POSTMAN_WORKSPACE_ID }}
          
          # Push Customer Feedback API
          echo "Pushing Customer Feedback API..."
          postman collection push postman/collections/Customer-Feedback-API.postman_collection.json \
            --workspace-id ${{ secrets.POSTMAN_WORKSPACE_ID }}
          
          echo "‚úÖ Successfully pushed all collections to Postman workspace!"
      
      - name: Notify Success
        if: success()
        run: |
          echo "üéâ Pipeline completed successfully!"
          echo "‚úÖ All tests passed"
          echo "‚úÖ Collections pushed to Postman workspace"
